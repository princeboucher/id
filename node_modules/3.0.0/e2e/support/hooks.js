var Cucumber = require("cucumber");
var reporter = require("cucumber-html-reporter");
var conf = require("../../protractor.conf").config;
var fs = require("fs");
var mkdirp = require("mkdirp");
var {defineSupportCode} = require('cucumber');

defineSupportCode(function({Before, After, registerListener}) {

	var reportsDir = "./e2e/reports";
	var targetJson = reportsDir + "/cucumber_report.json";

	Before(function() {
		return browser.get(conf.baseUrl);
	});

	After(function(scenario) {
		var attach = this.attach; // cucumber's world object has attach function which should be used
		return browser.takeScreenshot().then(function(png) {
			var decodedImage = new Buffer(png, "base64");
			return attach(decodedImage, "image/png");
		});
	});
	
	var cucumberReporteroptions = {
	    theme: "bootstrap",
	    jsonFile: targetJson,
	    output: reportsDir + '/Atlas-E2E.html',
	    reportSuiteAsScenarios: true,
	    brandTitle: 'End to End Test Report',
	    name: 'Atlas'
	};

	var logFn = string => {
	    if (!fs.existsSync(reportsDir)) {
	    	mkdirp.sync(reportsDir);
	    }
	    
	    try {
	    	fs.writeFileSync(targetJson, string);
	    	reporter.generate(cucumberReporteroptions); //invoke cucumber-html-reporter
	    } catch (err) {
	    	if (err) {
	    		console.log("Failed to save cucumber test results to json file.");
	    		console.log(err);
	    	}
	    }
	};

	var jsonformatter = new Cucumber.JsonFormatter({
		log: logFn
	});
		  
	registerListener(jsonformatter);
});